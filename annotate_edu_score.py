import json
import re
from tqdm import tqdm
from google import genai
from google.genai import types
from datasets import load_dataset
from datetime import datetime

#===============教育內容評估 Prompt===============
RUBRIC_PROMPT = """
你是一位經驗豐富的教育內容評估專家。你的任務是評估所提供的網頁內容的教育價值，並判斷其是否適合**中學到博士級（middle school to PhD levels）**的教學環境。
評估標準採用加分至，每符合一項條件加1分，最低0分(全部不符合)最高5分(全部符合)。請注意，評分標準為依序漸進的，前面的標準必然會包含於後面的標準中。舉例而言，若內容符合第4分的標準，也必然能夠滿足前3分的標準。
---

**評分標準：**
1.  滿足以下條件，獲得1分
內容僅提及零星的孤立事實或單一知識點，且包含大量非教育內容，缺乏學術分析或論證。內容不構成有效學習材料，無法用於任何正式或非正式的教學場合。
例如: 純粹的商品廣告、個人生活瑣事、飯店或旅遊地點的商業宣傳（僅強調服務與設施，缺乏地理、文化或歷史背景分析）、未經考證的坊間傳聞、或僅為單純表達個人喜好與情緒的內容
範例:
"眉毛清細疏勻，這對女性來說是平安清閑，可以豐衣足食，一生過很舒適的生活，只是個性過於柔順，容易沉溺於愛情之中，萬一選錯了對象，委身給愛情騙子，犧牲豈不是太大，所以必須小心提防。"
"位於保和島的絕佳家庭娛樂設施, 觀光, 海灘地段，邦勞民居旅店提供最好的環境，讓您遠離塵囂。 因為離市中心僅15 Km的路程，離機場也只有18 Km的路程，這間3.5星級酒店每年都會接待大量的旅客。 這家現代化酒店比鄰阿羅那海灘, 莫莫海灘, 菲律賓眼睛猴基金會等熱門景點。"
"跳至內容\nSearch\n您可以建立約會，並與群組的所有成員共用。 成員可從群組內部新增、變更或刪除約會。 在群組中建立的約會，同時會出現在 BlackBerry® 裝置的行事曆應用程式中。\n如需使用行事曆功能的詳細資訊，請在行事曆應用程式的功能表上按一下說明。\n此資訊對您是否有所助益？請將您的回應傳送給我們\n返回頁首\n版權所有 © 2013 BlackBerry，除非特別說明。"
---
2.  滿足以下條件，獲得第2分:
內容包含具教育價值的訊息，但訊息碎片化，難以形成完整知識結構，混雜較高比例的非教育成分（如過多商業信息、產品特點介紹、或無關緊要的私人細節），學習者需要大量時間自行篩選訊息，並需要教師進行大量額外引導才能獲得有限的知識點，無法獨立作為主要學習資源。

例如: 針對特定案例、產品、服務或行政流程的具體說明，目的側重於提供操作指引、背景資訊或單一事件描述、產品特點的簡易說明而非技術原理分析、歷史事件羅列而無因果關係探討、對藝術品或文化活動的初步描述但缺乏藝術理論或文化脈絡的深入介紹、特定國家簽證申請的步驟說明、單一企業或個人的簡介/訪談（不含對其作品或理論的深入學術分析）、或個人觀點多於學術論證的評論、「不具【深入】學術原理探討」的[文學、商業個案、影視、藝術、健康教育(非護理專業知識)、公民、社會、音樂、環保議題]或不具泛用性的單一個案
範例:
給想申請打工度假者們的建議。如果預定出國六個月以上，可以於出國前選擇繼續參加健保或辦理停保手續。在國外就醫時一定要向醫院索取醫療費用收據正本、費用明細及診斷書，並應於就醫後六個月內提出申請。Medibank Overseas visitor Cover 應該是 每月AUD$155.70。MBF 則是 AUD$149。
青鳥工作室由藝術家林俊廷創立，最初接藝術製作案，後轉型為藝術創作公司。公司成立約兩年，專注跨領域材質運用，雖不刻意追求科技藝術，但作品常因此歸類於此。取名「青鳥」源於尋找幸福的童話意象。公司希望在商業案之外，也能在新媒體藝術領域有所發展，並無特別設定藝術目標，而是著重整合創意，並在作品中突顯自身想法。近期作品與台大教授合作，探索超能力感知與科技藝術的結合。
IE7導致Outlook 2003/Express無法列印郵件標題。微軟已釋出Hotfix，建議受影響用戶聯絡客服取得。若問題不嚴重，建議等待IE7 Service Pack。Hotfix不需重啟，也不取代其他更新。因此，如果此問題沒有對您造成嚴重影響，Microsoft 建議您等候下一版包含此 Hotfix 的 Windows Internet Explorer 7 Service Pack。
作者因毛髮濃密，推薦飛利浦全方位按摩靚漾美體刀（HP6576），為音波按摩冰刀升級版。此美體刀設計時尚，搭載32抗菌陶瓷夾輪、LED燈、兩段轉速，並附刮、拔、修三種替換刀頭及LED眉夾。其優點為除毛效率高，毛髮再生細軟，肌膚更光澤。使用時應90度逆毛流，除毛後保濕。文中詳細說明使用步驟、最佳時機、週期，並解答疼痛、敏感肌、毛髮內生等常見問題。
“約翰・藍儂的《Imagine》是1971年創作的暢銷單曲，歌詞鼓勵人們想像一個沒有宗教、國界戰爭和物質隔閡的世界。這首歌成為他獨唱生涯最成功的作品，榮獲多項榮譽，包括格萊美名人堂和搖滾名人堂。其安詳旋律與深刻訊息賦予聽眾慰藉與希望，被《滾石》雜誌譽為「最偉大的音樂禮物」。該曲在全球廣為傳唱，被無數藝術家翻唱，並常在重大國際活動中播放，成為和平與團結的普世象徵。”
3.  滿足以下條件，獲得第3分:
內容圍繞一個「明確的基礎學科」相關知識進行闡述，包含了知識的初步呈現、定義或基礎概念的解釋。經整理後適合作為入門教育材料，但「深度有限」，未觸及複雜理論或多層次分析。大部分內容是教育性的，非教育內容（如品牌宣傳、私人瑣事）比例低且不影響學習。學生在閱讀後能建立對主題的基本認識，但可能需要教師進行補充說明。
例如: 包含特定學科知識的產品特點介紹、文學個案、藝術個案、歷史個案、公民個案、法律個案、社會議題、建築設計構想、都市計畫
請注意，若無大學四年級(近研究所)等級的教育內容，3分是「具有學術原理探討的文學、影視、藝術、健康教育(非護理專業知識)、公民、社會、音樂、環保或不具泛用性的單一個案」相關文本(無論內容深入與否)所能獲得的最高分數
範例:
國泰金融控股公司於2001年成立，整合保險、證券、銀行等多元金融服務，旨在提供客戶「一站購足」的便利。公司設有多個部門，如總經理室綜理業務，各處負責財務、行銷、策略規劃、經濟研究、風險管理、資訊、行政、法務、會計、公關、整合行銷等職能。內部稽核組織隸屬董事會，設有總稽核及專任稽核人員，執行母公司與子公司定期及專案查核，包括股務、衍生性金融商品等。稽核處定期向審計委員會及董事會報告執行情形，追蹤改善缺失，並負責內部控制制度的修訂、自行查核督導、與子公司內部稽核成效考核，確保營運合規及有效性。
"航海，是人類在海上航行，跨越海洋，由一方陸地去到另一方陸地的活動。 在從前是一種冒險行為，因為人類的地理知識有限，彼岸是不可知的世界。從冒險行為，慢慢的轉變於一種商業行為，因為當船到達了另一個地方，船員開始在當地生活，習慣與風俗 漸漸的同化了當地的人種，此為航海最基礎的成果，漸漸的各國的發展慢慢的開始了移民與殖民，有了貿易，商業行為慢慢的活絡了起來，至今 商業貿易還是航海的最主要目的。
“汽車機油不適用於機車，因其引擎設計與操作環境差異大。機車引擎工作溫度可達160度，遠高於汽車，且機油量少、多為氣冷，散熱較差。其單位馬力輸出、轉速皆高，對機油的耐高溫、抗氧化及油膜穩定性要求嚴苛。此外，機車對密封、抗震、抗剪力、抗壓及轉速要求不同，檔車更需含止滑劑的專用油，以確保引擎保護與順暢運轉。”
“此為Dassault Systèmes SolidWorks Corporation授予SolidWorks軟體及相關產品的「非獨家、不可轉讓」使用許可協議，用戶僅獲使用權，不擁有軟體。許可範圍限於單機或網路版指定數量，並有地區限制，不可轉移至他國。用戶不得修改、反向工程、轉讓或租賃軟體。訂閱服務提供更新、升級及技術支援。軟體包含安全機制，可偵測非法使用並收集非個人識別資料。協議提供有限保證與責任限制，並受美國及英國出口法規約束，由美國麻州法律管轄。”
“國際純化學和應用化學聯合會（IUPAC）成立於1919年，是代表全球化學家的國際聯盟，隸屬國際科學理事會。總部在瑞士蘇黎世，行政辦公室在美國。IUPAC是化學元素及化合物命名標準的權威機構，負責統一化學術語、推廣化學知識及出版文獻。它由多個委員會治理，在二戰後持續規範化學命名與科學方法。IUPAC主辦了2011年國際化學年，並持續進行多項化學研究計畫，確保全球化學領域的標準化與進步。”
4.  滿足以下條件，獲得第4分:
內容教育性佔比高，非教育性成分極少。圍繞核心學術主題，是公認的學術領域、學科理論，與相關學術課程或學科教育目標高度相關且深度對齊，提供清晰的介紹，用語符合學科基本規範，協助學習者建立對該領域的知識框架。適合作為課程單元的主幹材料或用於輔助深入學習的案例。「請嚴格確保前面數個評分標準中所提及的範例文本種類不會獲得第4分」。
荷蘭特文特大學科學家利用3D微納米製造技術「角落石版印刷」，創造出內含活細胞的微型金字塔。這種開放式3D環境能改善傳統2D研究的非自然性，使細胞（如軟骨細胞）在金字塔內與鄰近細胞自然協同作用。此技術有助於深入研究細胞表現型變化，是組織再生領域的有為工具。未來發展包括中空邊緣和納米流體通道，以供應細胞。
潘諾尼亞海（又名副特提斯洋）是位於現今歐洲潘諾尼亞平原的史前淺海。它形成於漸新世至中新世，初期與特提斯洋相連，後於中新世時隔離。上新世時，潘諾尼亞海達到最大面積，沉積層厚達3-4公里，並曾透過傑爾達普海峽與瓦拉幾亞黑海地區相連。海平面最高時，其範圍南至塞爾維亞，摩拉瓦河谷成為海灣並與愛琴海連接。該海存在約3000萬年，最終於約60萬年前的更新世中期消失。
5.  滿足以下條件，獲得第5分:
內容極大部分皆為對學術原理或學科知識的介紹。提供理論、模型、複雜概念或跨學科議題解析。著重於學科的本質、演進與潛在影響。內容本身提供完整的學術學習路徑，可作為核心教材或獨立教學資。
例如: 教科書、教學網站內容
範例:
“純量勢（或稱純量位，常用Φ表示）是向量分析與物理學的基本概念。它是一個純量場V，對其取負值梯度可得到向量場F（即F = -∇V）；反之，V也能定義一個向量場F。純量勢的物理意義依場的類型而異：對於流體或氣體流，流向與純量勢最陡降方向一致；對於力場，加速度方向亦同，且純量勢與勢能密切相關。並非所有向量場都存在純量勢。擁有純量勢的向量場稱為保守向量場，這與物理學中的保守力概念相符。在各種速度場中，層狀場皆具有純量勢；而螺線向量場僅在拉普拉斯場的情況下才能有純量勢。”
“過氧化氫（H₂O₂），俗稱雙氧水，是除水外的另一種氫氧化物，呈淡藍粘稠液體，化學性質不穩定，通常以水溶液形式存放。它比水粘稠，沸點和介電係數較高，純淨時穩定，但加熱或遇催化劑（如生物體內過氧化氫酶、二氧化錳、重金屬離子）會猛烈分解為水和氧氣。H₂O₂可與水互溶，呈弱酸性。1818年L.J.Thenard發現過氧化氫。1950年代前主要透過電解硫酸氫鹽溶液製備，現今則普遍採用更環保高效的烷基蒽醌法。過氧化氫是非常強的氧化劑，自身可歧化分解。其分解受重金屬離子催化，芬頓試劑即為H₂O₂與Fe²⁺的混合液，產生自由基。為減緩分解，市售雙氧水常添加穩定劑。它能氧化多種無機離子（如Fe²⁺至Fe³⁺、亞硫酸根至硫酸根）和有機物（如硫醚氧化為亞碸、烯烴環氧化），還原時生成水，不引入雜質。H₂O₂也能與其他物質反應生成新的過氧化物，如過氧化鈉、過硼酸鈉、過氧酸、三過氧化三丙酮等。其鹼性很弱，僅與超強酸反應。過氧化氫廣泛應用於殺菌消毒（稀溶液）、紡織品和紙張漂白、染髮劑、化學合成原料，甚至作為火箭推進劑。它還能修復因硫化鉛變黑的含鉛白藝術品。使用不當具危險性：誤飲或灌腸會侵蝕黏膜；注射則導致血栓甚至生命危險；食品加工一般禁用。歷史上，過氧化氫曾導致火箭爆炸和潛艇魚雷事故，二戰期間更被納粹德國用於人體實驗。”

---

請依編號順序評估以下網頁內容:
{extract}

請確保保留內容開頭的 `[編號]` 並在輸出中包含它。
請以 `[<編號>] 分數:<總分數> 解釋:<簡要說明理由>` 的格式輸出你的評估結果。分數應為阿拉伯數字 (1-5)。`解釋` 字數限制：50字。
"""

class EduContentEvaluator:
    def __init__(self, api_key, dataset_name="voidful/fineweb-zhtw", num_samples=100, batch_size=100):
        self.client = genai.Client(api_key=api_key)
        self.dataset_name = dataset_name
        self.num_samples = num_samples
        self.batch_size = batch_size
        self.data = self.load_data()

    #===============從 Hugging Face 載入資料===============
    def load_data(self):
        # 使用 streaming 模式載入資料集
        ds = load_dataset(self.dataset_name, split="train", streaming=True)
        # 載入前 num_samples 筆資料
        data = []
        for i, sample in enumerate(ds):
            if i >= self.num_samples:
                break
            data.append({"index": i + 1, **sample})
        return data

    #===============合併文字資料為批次===============
    def merge_texts(self):
        merged_batches = []
        for i in range(0, len(self.data), self.batch_size):
            batch = self.data[i:i + self.batch_size]
            merged_text = '\n'.join([f"[{item['index']}] {item['text']}" for item in batch])
            merged_batches.append({"merged_text": merged_text})
        return merged_batches

    #===============解析 LLM 評分輸出===============
    def parse_llm_output(self, llm_output):
        pattern = r"\[(\d+)\]\s*分數\s*[:：]\s*(\d+)\s*解釋\s*[:：]\s*(.*?)(?=\n\[|\Z)"
        matches = re.findall(pattern, llm_output, re.DOTALL)
        return {int(idx): {"score": int(score), "explain": explanation.strip()} for idx, score, explanation in matches}

    #===============將 LLM 評分結果合併到資料===============
    def merge_llm_results_to_data(self, llm_output):
        parsed_results = self.parse_llm_output(llm_output)
        for item in self.data:
            idx = item['index']
            if idx in parsed_results:
                item['score'] = parsed_results[idx]['score']
                item['explain'] = parsed_results[idx]['explain']
            else:
                item['score'] = None
                item['explain'] = "LLM 無回應或解析失敗"
        return self.data

    #===============與 Gemini LLM 互動===============
    def response_gemini(self, prompt, model="gemini-2.5-flash-preview-05-20"):
        response = self.client.models.generate_content(
            model=model,
            contents=str(prompt),
            config=types.GenerateContentConfig(topP=0.1, temperature=0, topK=1)
        )
        return response.text

    #===============執行內容評分流程===============
    def evaluate_content(self):
        merged_batches = self.merge_texts()
        score_outputs = []
        for batch in tqdm(merged_batches[:1], desc="LLM評分中"):  # 僅處理第一批次
            merged_text = batch["merged_text"]
            prompt = RUBRIC_PROMPT.format(extract=merged_text)
            reply_score = self.response_gemini(prompt)
            score_outputs.append(reply_score)
        self.data = self.merge_llm_results_to_data(score_outputs[-1])

    #===============儲存處理後的資料===============
    def save_data(self, output_path):
        # 自訂 JSON 編碼器來處理 datetime 物件
        class DateTimeEncoder(json.JSONEncoder):
            def default(self, obj):
                if isinstance(obj, datetime):
                    return obj.isoformat()  # 將 datetime 轉為 ISO 8601 字串
                return super().default(obj)

        with open(output_path, "w", encoding="utf-8") as f:
            json.dump(self.data, f, ensure_ascii=False, indent=2, cls=DateTimeEncoder)

#===============主程式：執行評分與儲存===============
if __name__ == "__main__":
    api_key = "" #參考用量限制:https://ai.google.dev/gemini-api/docs/rate-limits?hl=zh-tw
    output_path = "" #可自行更改

    evaluator = EduContentEvaluator(api_key)
    evaluator.evaluate_content()
    evaluator.save_data(output_path)